# 系统架构文档

## 整体架构

本系统采用**私有化混合架构**，在本地环境中协同运行大语言模型（LLM）和视频生成模型，实现从文本到视频的完整创作流程。

```
┌─────────────────────────────────────────────────────────┐
│                      用户交互层                          │
│              (HTML + JavaScript + Bootstrap)            │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP/REST API
┌────────────────────▼────────────────────────────────────┐
│                   后端服务层                             │
│              (FastAPI + Python)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  任务管理    │  │  API路由     │  │  日志系统    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                  业务逻辑层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 任务处理器   │  │  队列管理    │  │  模型加载器  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                  模型推理层                              │
│  ┌──────────────────────┐  ┌──────────────────────┐    │
│  │   LLM推理服务        │  │  视频生成服务        │    │
│  │  (脚本生成/分镜拆解)  │  │  (Diffusion Model)  │    │
│  └──────────────────────┘  └──────────────────────┘    │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                  数据存储层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  任务数据    │  │  视频文件    │  │  日志文件    │  │
│  │  (SQLite)    │  │  (本地存储)  │  │  (本地存储)  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. 用户交互层
- **技术栈**: HTML5 + JavaScript + Bootstrap
- **功能**: 
  - 用户输入创作指令
  - 任务状态实时查询
  - 视频预览和下载
  - 历史任务管理

### 2. API服务层
- **技术栈**: FastAPI + Pydantic
- **功能**:
  - RESTful API接口
  - 请求验证和错误处理
  - 静态文件服务
  - CORS跨域支持

### 3. 任务处理层
- **组件**:
  - 任务队列管理器
  - 后台任务处理器
  - 任务状态追踪
- **特点**:
  - 异步任务处理
  - 并发控制
  - 错误恢复机制

### 4. LLM推理服务
- **功能**:
  - 自然语言理解
  - 脚本生成
  - 分镜拆解
  - Prompt优化
- **技术**:
  - PyTorch
  - Transformers
  - 本地模型推理

### 5. 视频生成服务
- **功能**:
  - 场景视频生成
  - 视频片段拼接
  - 后处理（字幕、音乐）
- **技术**:
  - Diffusion Model
  - OpenCV
  - MoviePy

### 6. 数据管理层
- **存储**:
  - 任务元数据（SQLite）
  - 视频文件（本地文件系统）
  - 日志文件（本地文件系统）

## 数据流

### 视频生成流程
```
用户输入
  ↓
创建任务 → 加入队列
  ↓
LLM生成脚本 → 分镜拆解
  ↓
逐个生成视频片段
  ↓
视频拼接 → 后处理
  ↓
保存结果 → 返回用户
```

### 任务状态机
```
pending → processing → completed
                    ↘ failed
```

## 技术选型理由

### 前端
- **Bootstrap**: 快速构建响应式界面
- **原生JavaScript**: 轻量级，无需复杂构建

### 后端
- **FastAPI**: 高性能异步框架，自动生成API文档
- **Python**: 丰富的AI/ML生态系统

### 模型
- **PyTorch**: 灵活的深度学习框架
- **Transformers**: 预训练模型支持
- **Diffusers**: 扩散模型工具库

### 存储
- **SQLite**: 轻量级，适合本地部署
- **文件系统**: 直接存储视频，简单高效

## 扩展性设计

### 水平扩展
- 支持多GPU并行推理
- 任务队列可替换为Redis/RabbitMQ
- 数据库可迁移至PostgreSQL/MySQL

### 垂直扩展
- 模块化设计，易于替换模型
- 插件化架构，支持自定义处理器
- API版本控制，向后兼容

## 安全性设计

### 数据安全
- 所有数据本地存储
- 无外部网络依赖
- 支持访问控制

### 系统安全
- 输入验证和清理
- 错误处理和日志记录
- 资源限制和超时控制
